module;
#include <Windows.h>
#include "../../Classes/Process.h"


import Exception;

export module APCQueue;

export namespace MW::Execute
{
    // Asynchronous Procedure Call (APC) Queue
    // Saadaan toisen prosessin käynnissä oleva thread suorittamaan meidän koodia luomatta uutta threadia
    // Sijoitetaan haluttu koodi jo käynnissä olevan threadin APC jonoon, jolloin se suorittaa sen kun thread siirtyy "alertable" stateen
    bool APCQueueExecuteCode(LPVOID allocatedAddr, const Process &proc)
    {
        const DWORD queueSuccess{ QueueUserAPC((PAPCFUNC)allocatedAddr, proc.getThreadHandle(), NULL) };

        if (!queueSuccess)
        {
            throw Exception("QueueUserAPC returned NULL", "APCQueueExecuteCode");
        }

        return true;
    }
}